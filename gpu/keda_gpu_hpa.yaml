kind: Deployment
apiVersion: apps/v1
metadata:
  name: gpu-bench
  namespace: gpu
spec:
  replicas: 0
  selector:
    matchLabels:
      app: gpu-bench
  template:
    metadata:
      creationTimestamp: null
      labels:
        app: gpu-bench
    spec:
      containers:
        - name: gpu-bench
          image: 'quay.io/openshift-psap/gpu-burn:latest'
          args:
            - gpu-burn
            - '3600'
          resources:
            limits:
              nvidia.com/gpu: '1'
      tolerations:
        - key: nvidia.com/gpu
          operator: Exists
          effect: NoSchedule
---
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: gpu-scaledobject
  namespace: gpu
spec:
  scaleTargetRef:
    name: gpu-bench
  maxReplicaCount: 5
  minReplicaCount: 1
  pollingInterval: 10
  triggers:
    - authenticationRef:
        kind: ClusterTriggerAuthentication
        name: keda-trigger-auth-prometheus
      metadata:
        authModes: bearer
        metricName: DCGM_FI_DEV_GPU_UTI
        namespace: nvidia-gpu-operator
        query: 'sum(avg_over_time(DCGM_FI_DEV_GPU_UTIL{exported_pod=~"gpu-bench.*"}[30s]))'
        serverAddress: 'https://thanos-querier.openshift-monitoring.svc.cluster.local:9092'
        threshold: '30'
      type: prometheus
